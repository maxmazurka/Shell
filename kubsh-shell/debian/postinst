#!/bin/bash
set -e

echo "üöÄ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Kubsh –ø–æ—Å–ª–µ —É—Å—Ç–∞–Ω–æ–≤–∫–∏..."

# 1. –°–æ–∑–¥–∞—ë–º –≥—Ä—É–ø–ø—É fuse –µ—Å–ª–∏ –µ—ë –Ω–µ—Ç
if ! getent group fuse >/dev/null; then
    groupadd fuse
    echo "‚úì –ì—Ä—É–ø–ø–∞ fuse —Å–æ–∑–¥–∞–Ω–∞"
fi

# 2. –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –≥—Ä—É–ø–ø—É fuse
if [ -n "$SUDO_USER" ]; then
    usermod -a -G fuse "$SUDO_USER"
    echo "‚úì –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å $SUDO_USER –¥–æ–±–∞–≤–ª–µ–Ω –≤ –≥—Ä—É–ø–ø—É fuse"
    echo "‚ö†Ô∏è  –í—ã–π–¥–∏—Ç–µ –∏ –∑–∞–π–¥–∏—Ç–µ –∑–∞–Ω–æ–≤–æ, —á—Ç–æ–±—ã –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤—Å—Ç—É–ø–∏–ª–∏ –≤ —Å–∏–ª—É!"
fi

# 3. –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∞–≤–∞ –Ω–∞ /dev/fuse
if [ -e /dev/fuse ]; then
    chmod 666 /dev/fuse 2>/dev/null || true
    echo "‚úì –ü—Ä–∞–≤–∞ –Ω–∞ /dev/fuse –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã"
fi

# 4. –°–æ–∑–¥–∞—ë–º —Ç–æ—á–∫—É –º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
mkdir -p /opt/users
chmod 777 /opt/users
echo "‚úì –¢–æ—á–∫–∞ –º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏—è /opt/users —Å–æ–∑–¥–∞–Ω–∞"

# 5. –ó–∞–≥—Ä—É–∂–∞–µ–º –º–æ–¥—É–ª—å FUSE
modprobe fuse 2>/dev/null || true
echo "‚úì –ú–æ–¥—É–ª—å FUSE –∑–∞–≥—Ä—É–∂–µ–Ω"

# 6. –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ /etc/fuse.conf –¥–ª—è allow_other
if [ -f /etc/fuse.conf ]; then
    if ! grep -q "^user_allow_other" /etc/fuse.conf; then
        echo "user_allow_other" >> /etc/fuse.conf
        echo "‚úì /etc/fuse.conf –Ω–∞—Å—Ç—Ä–æ–µ–Ω"
    fi
fi

echo "‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Kubsh –∑–∞–≤–µ—Ä—à–µ–Ω–∞!"
echo "üëâ –î–ª—è –∑–∞–ø—É—Å–∫–∞: –ø—Ä–æ—Å—Ç–æ –≤–≤–µ–¥–∏ 'kubsh' –≤ —Ç–µ—Ä–º–∏–Ω–∞–ª–µ"
exit 0
