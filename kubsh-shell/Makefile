TARGET = kubsh
VERSION = 0.1.0

CXX = g++
CXXFLAGS = -std=c++17 -Wall -Wextra -D_FILE_OFFSET_BITS=64 -I/usr/include/fuse3 -static -no-pie
LDFLAGS = -lfuse3 -pthread -static

SOURCES = main.cpp vfs.cpp
OBJECTS = $(SOURCES:.cpp=.o)

.PHONY: all build run clean package test help

all: build

build: $(TARGET)

$(TARGET): $(OBJECTS)
	$(CXX) -o $@ $^ $(LDFLAGS)

%.o: %.cpp
	$(CXX) $(CXXFLAGS) -c $< -o $@

run: build
	./$(TARGET)

package: build
	@echo "üì¶ –°–æ–∑–¥–∞—ë–º DEB-–ø–∞–∫–µ—Ç..."
	mkdir -p package/usr/bin
	mkdir -p package/DEBIAN
	cp $(TARGET) package/usr/bin/
	chmod 755 package/usr/bin/$(TARGET)
	
	# –ö–æ–ø–∏—Ä—É–µ–º postinst —Å–∫—Ä–∏–ø—Ç
	if [ -f debian/postinst ]; then \
		cp debian/postinst package/DEBIAN/; \
		chmod 755 package/DEBIAN/postinst; \
		echo "‚úì postinst —Å–∫—Ä–∏–ø—Ç –¥–æ–±–∞–≤–ª–µ–Ω"; \
	fi
	
	@echo "Package: kubsh" > package/DEBIAN/control
	@echo "Version: $(VERSION)" >> package/DEBIAN/control
	@echo "Section: utils" >> package/DEBIAN/control
	@echo "Priority: optional" >> package/DEBIAN/control
	@echo "Architecture: amd64" >> package/DEBIAN/control
	@echo "Maintainer: Student <student@example.com>" >> package/DEBIAN/control
	@echo "Depends: libfuse3-4, fuse3, adduser" >> package/DEBIAN/control
	@echo "Description: Custom shell with VFS" >> package/DEBIAN/control
	@echo " Shell with command history, PATH execution, SIGHUP and VFS." >> package/DEBIAN/control
	dpkg-deb --build package kubsh_$(VERSION)_amd64.deb
	rm -rf package
	@echo "‚úÖ –ü–∞–∫–µ—Ç —Å–æ–∑–¥–∞–Ω: kubsh_$(VERSION)_amd64.deb"


test: build
	@echo "üß™ –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–µ—Å—Ç—ã –≤ Docker..."
	docker run --rm --privileged -v /dev/fuse:/dev/fuse -v $$(pwd):/mnt tyvik/kubsh_test:master bash -c "apt-get update && apt-get install -y libfuse3-4 fuse3 pkg-config && echo 'user_allow_other' >> /etc/fuse.conf && ldconfig && export LD_LIBRARY_PATH=/usr/lib/x86_64-linux-gnu:$$LD_LIBRARY_PATH && cp /mnt/kubsh /usr/local/bin/ && chmod +x /usr/local/bin/kubsh && cd /opt && pytest -v"

clean:
	rm -f $(TARGET) *.o *.deb
	rm -rf package
	rm -rf /opt/users 2>/dev/null || true

help:
	@echo "========================================"
	@echo "  KUBSH - Makefile"
	@echo "========================================"
	@echo "  make build   - –∫–æ–º–ø–∏–ª—è—Ü–∏—è –ø—Ä–æ–µ–∫—Ç–∞"
	@echo "  make run     - –∑–∞–ø—É—Å–∫ —à–µ–ª–ª–∞"
	@echo "  make package - —Å–±–æ—Ä–∫–∞ deb-–ø–∞–∫–µ—Ç–∞"
	@echo "  make test    - –∑–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤ (Docker)"
	@echo "  make clean   - –æ—á–∏—Å—Ç–∫–∞"
	@echo "  make help    - —ç—Ç–∞ —Å–ø—Ä–∞–≤–∫–∞"
	@echo "========================================"
